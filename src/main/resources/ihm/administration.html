<!DOCTYPE html>
<html>
	<head>
		<title>Administration</title>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- Bootstrap -->
		<link href="css/bootstrap-min.css" rel="stylesheet">

		<!-- Css -->
		<link href="css/doi.css" rel="stylesheet">
		<link href="css/navbar.css" rel="stylesheet">

	</head>

	<body>
		<div class="container">

			<div id="navbar"></div>

			<h2>Administration</h2><hr>

			<div class="row">
				<div class="col-md-6">
					<div class="panel panel-primary">
						<div class="panel-heading"><h3 class="panel-title">Projets</h3></div>
						<div class="panel-body">
							<div class="col-md-6">
								<button type="button" onclick="addProject()" class="btn btn-default btn-md btn-block">Créer un projet</button>
								<button type="button" onclick="renameProject()" class="btn btn-default btn-md btn-block">Renommer un projet</button>
								<button type="button" onclick="deleteProject()" class="btn btn-default btn-md btn-block">Supprimer un projet</button>
							</div>	
							<div class="col-md-6">	
								<label>Projets</label>
								<select class="form-control" size="4" id="listProjet">
						<!--  			<option>Projet A</option>
									<option>Projet B</option>
									<option>Projet C</option>
									<option>Projet D</option>
									<option>Projet E</option>
									<option>Projet F</option>  -->
								</select>
							</div>			
						</div>
					</div> <!-- /panel -->
				</div>
			
				<div class="col-md-6">
					<div class="panel panel-primary">
						<div class="panel-heading"><h3 class="panel-title" id="titreProjet">Utilisateurs du projet:</h3></div>
						<div class="panel-body">
							<div class="col-md-6">	
								<label>Utilisateurs</label>
								<select id="listUser" class="form-control" size="4">
							<!--  		<option>bob.doe</option>
									<option>bill.doret</option>
									<option>tom.hash</option>  -->
								</select>
							</div>			
							<div class="col-md-6">
								<button type="button" onclick="addUser()" class="btn btn-default btn-md btn-block">Ajouter un utilisateur</button>
								<button type="button" onclick="deleteUser()" class="btn btn-default btn-md btn-block">Retirer un utilisateur</button>
							</div>	
						</div>
					</div> <!-- /panel -->
				</div>
			</div> <!-- /row -->
			<br>

			<div class="row">
				<div class="col-md-6">
					<div class="panel panel-primary">
						<div class="panel-heading"><h3 class="panel-title">Groupe Admin</h3></div>
						<div class="panel-body">
							<div class="col-md-6">	
								<label>Utilisateurs Admin</label>
								<select id="listAdmin" class="form-control" size="4">
						<!--  			<option>bob.doe</option>
									<option>bill.doret</option>   -->
								</select>
							</div>			
							<div class="col-md-6">
								<button type="button" onclick="addAdmin()" class="btn btn-default btn-md btn-block">Ajouter un utilisateur</button>
								<button type="button" onclick="deleteAdmin()" class="btn btn-default btn-md btn-block">Retirer un utilisateur</button>
							</div>	
						</div>
					</div> <!-- /panel -->
				</div>
			</div> <!-- /row -->

			<hr>
			<div id="footer"></div>

		</div> <!-- /container -->
			 
  	</body>
  	
  		<!-- JS library -->
		<script src="js/jquery-min.js"></script>
		<script src="js/bootstrap-min.js"></script>

		<script>
		var users;
		var admins;
		var projets;
		
		$(document).ready(function(){
			$("#footer").load("footer.txt");
			$("#navbar").load("navbar.txt", function(responseTxt, statusTxt, xhr){
		        if(statusTxt == "success"){
		        	$("#selection").parent().remove();
		        } else if(statusTxt == "error"){
		            alert("Error: " + xhr.status + ": " + xhr.statusText);
		        }
		    });
			
			getListProjet();
			getListAdmin();

			$("#listProjet").click(function(){
				if($("#listProjet").val() == null){
					return;
				}
				modifyListUser();
			});
			
		});
		
		function getListProjet(){
			$.ajax({
			    type: "GET",
			    url: "http://127.0.0.1:8182/admin/projects",
			    headers: {
			    	'Authorization': 'Basic ' + btoa('malapert:pwd')
			    },
			    crossDomain: true,
				cache : false,
			    error : function (XMLHttpRequest, textStatus, errorThrown){ 
			    	console.log("La requête GET(listProjet) a échouée."); 
			    	alert("GET getListProjet : status = " + textStatus);
			    },
			    success: function(json) {
			    	console.log(json);
			    	projets = json; 
			    	console.log("GET getListProjet est un succès.");
			    	for(project in json){
			    		$("#listProjet").append("<option>" + project + "(" + json[project] + ")" + "</option>");	
			    	}
			    }
			});
		}
		
		function getListAdmin(){
			$.ajax({
			    type: "GET",
			    url: "http://127.0.0.1:8182/admin/superusers",
			    headers: {
			    	'Authorization': 'Basic ' + btoa('malapert:pwd')
			    },
			    crossDomain: true,
				cache : false,
			    error : function (XMLHttpRequest, textStatus, errorThrown){ 
			    	console.log("La requête GET(getListAdmin) a échouée."); 
			    	alert("GET getListAdmin : status = " + textStatus);
			    },
			    success: function(array) {
			    	console.log(array);
			    	admins = array; 
			    	console.log("GET getListAdmin est un succès.");
			    	array.forEach(function(admin, index, array){
			    		$("#listAdmin").append("<option>" + admin + "</option>");	
			    	});
			    }
			});
		}
		
		// modification Projets
		function addProject() {
		    var projet = prompt("Entrer le nom du projet:", "PROJET X");
		    if (projet == null || projet == "") {
		        return;
		    } else {
		    	$.ajax({
				    type: "POST",
				    url: "http://127.0.0.1:8182/admin/projects",
				    data: {
				    	'projectName': projet
				    },
				    headers: {
				    	'Authorization': 'Basic ' + btoa('malapert:pwd')
				    },
				    crossDomain: true,
					cache : false,
				    error : function (XMLHttpRequest, textStatus, errorThrown){ 
				    	console.log("La requête POST(addProject) a échouée."); 
				    	alert("POST addProject : status = " + textStatus);
				    },
				    success: function(suffixeProjet) {
				    	console.log(suffixeProjet);
				    	console.log("POST addProject est un succès.");
			    		$("#listProjet").append("<option selected=\"selected\">" + projet + 
			    				"(" + suffixeProjet + ")" + "</option>");	
			    		modifyListUser();
				    }
				});
		    }
		}
		
		function renameProject() {
			var text = $("#listProjet option:selected").text();
			if(text == ""){
				return;
			}
			
			var idText = text.substring(text.indexOf('(')+1, text.length -1);
			var nomText = text.substring(0, text.indexOf('('));
			console.log(nomText + " " + idText);
			
		    var projet = prompt("Renomer le projet:", nomText);
		    if (projet == null || projet == "") {
		        return;
		    } else {
		    	$.ajax({
				    type: "POST",
				    url: "http://127.0.0.1:8182/admin/projects/" + idText,
				    data: {
				    	'newProjectName': projet
				    },
				    headers: {
				    	'Authorization': 'Basic ' + btoa('malapert:pwd')
				    },
				    crossDomain: true,
					cache : false,
				    error : function (XMLHttpRequest, textStatus, errorThrown){ 
				    	console.log("La requête POST(renameProject) a échouée."); 
				    	alert("POST renameProject : status = " + textStatus);
				    },
				    success: function(boo) {
				    	console.log("POST renameProject est un succès.");
				    	console.log("isRenamed = "+ boo);
				    	if(boo){
					    	$("#listProjet option:selected").text( projet + 
				    				"(" + idText + ")" );	
					    	$("#titreProjet").text("Utilisateurs du projet: "+ projet + idText);
				    	}
				    }
				});
		    }
		}
		
		function deleteProject() {  // ATTENTION manque la vérification des DOIs sur le projet
			var text = $("#listProjet option:selected").text();
			if(text == ""){
				return;
			}
			var idText = text.substring(text.indexOf('(')+1, text.length -1);
			var nomText = text.substring(0, text.indexOf('('));
			console.log(nomText + " " + idText);
			
		    if(confirm("Voulez-vous vraiment supprimer le projet "+ nomText)){
		    	
		    	$.ajax({
				    type: "DELETE",
				    url: "http://127.0.0.1:8182/admin/projects/" + idText,
				    headers: {
				    	'Authorization': 'Basic ' + btoa('malapert:pwd')
				    },
				    crossDomain: true,
					cache : false,
				    error : function (XMLHttpRequest, textStatus, errorThrown){ 
				    	console.log("La requête DELETE(deleteProject) a échouée."); 
				    	alert("DELETE deleteProject : status = " + textStatus);
				    },
				    success: function(boo) {
				    	console.log("DELETE deleteProject est un succès.");
				    	console.log("isDeleted = "+ boo);
				    	if(boo){
					    	$("#listProjet option:selected").remove();
					    	$("#titreProjet").text("Utilisateurs du projet: ");
							$("#listUser").empty();	
				    	}
				    }
				});
		    } 
		}
		function modifyListUser(){
			var project = $("#listProjet").val();
			$("#titreProjet").text("Utilisateurs du projet: "+project);
			$("#listUser").empty();
			
			var suffixProject = project.substring(project.indexOf('(')+1, project.length -1);
			var nameProject = project.substring(0, project.indexOf('('));
			console.log(nameProject + " " + suffixProject);
			
			$.ajax({
			    type: "GET",
			    url: "http://127.0.0.1:8182/admin/projects/" + suffixProject + "/users",
			    headers: {
			    	'Authorization': 'Basic ' + btoa('malapert:pwd')
			    },
			    crossDomain: true,
				cache : false,
			    error : function (XMLHttpRequest, textStatus, errorThrown){ 
			    	console.log("La requête GET(modifyListUser) a échouée."); 
			    	alert("GET modifyListUser : status = " + textStatus);
			    },
			    success: function(array) {
			    	console.log(array);
			    	users = array; 
			    	console.log("GET modifyListUser est un succès.");
			    	array.forEach(function(user, index, array){
			    		$("#listUser").append("<option>" + user + "</option>");	
			    	});
			    }
			});
		}
			
		// modification users
		function addUser(){
			var project = $("#listProjet").val();
			
			
			var suffixProject = project.substring(project.indexOf('(')+1, project.length -1);
			var nameProject = project.substring(0, project.indexOf('('));
			console.log(nameProject + " " + suffixProject);
			
			var user = prompt("Entrer le \"nom.prenom\" de l'utilisateur qui sera associé à ce projet:", "toto.toto");
			if (user == null || user == "") {
		        return;
// 			} else if (!user.includes(".")) {
// 				alert("Format invalide.");
// 				return;
			} else {
				$.ajax({
				    type: "POST",
				    url: "http://127.0.0.1:8182/admin/projects/" + suffixProject + "/users",
				    headers: {
				    	'Authorization': 'Basic ' + btoa('malapert:pwd')
				    },
				    data: {
				    	"user": user
				    },
				    crossDomain: true,
					cache : false,
				    error : function (XMLHttpRequest, textStatus, errorThrown){ 
				    	console.log("La requête POST(addUser) a échouée."); 
				    	alert("POST addUser : status = " + textStatus);
				    },
				    success: function(boo) {
				    	console.log("POST addUser est un succès.");
				    	console.log(boo);
				    	if(boo){
					    	$("#listUser").append("<option selected=\"selected\">" + user + "</option>");
				    	}
				    }
				});
			}
		}
		
		function deleteUser(){
			var project = $("#listProjet").val();
			
			var suffixProject = project.substring(project.indexOf('(')+1, project.length -1);
			var nameProject = project.substring(0, project.indexOf('('));
			console.log(nameProject + " " + suffixProject);
			
			var user = $("#listUser").val();
			
			if(user == ""){
				return;
			}
			
			if(confirm("Voulez-vous vraiment supprimer l'utilisateur "+ user + " du projet " + nameProject + " ?")){
			    
				$.ajax({
				    type: "DELETE",
				    url: "http://127.0.0.1:8182/admin/projects/" + suffixProject + "/users/" + user,
				    headers: {
				    	'Authorization': 'Basic ' + btoa('malapert:pwd')
				    },
				    crossDomain: true,
					cache : false,
				    error : function (XMLHttpRequest, textStatus, errorThrown){ 
				    	console.log("La requête DELETE(deleteUser) a échouée."); 
				    	alert("DELETE deleteUser : status = " + textStatus);
				    },
				    success: function(boo) {
				    	console.log("DELETE deleteUser est un succès.");
				    	console.log(boo);
				    	if(boo){
					    	$("#listUser option:selected").remove();				    		
				    	}
				    }
				});
		    } 
		}
			
		// modification Admin   //TODO maybe show up a hidden select button that allow to find any user...
		function addAdmin(){
			var user = prompt("Entrer le \"nom.prenom\" de l'utilisateur qui passera Admin :\n(possibilité d'afficher les noms disponibles ici)", "toto.toto");
			if (user == null || user == "") {
		        return;
			} else {
				$.ajax({
				    type: "POST",
				    url: "http://127.0.0.1:8182/admin/superusers",
				    headers: {
				    	'Authorization': 'Basic ' + btoa('malapert:pwd')
				    },
				    data: {
				    	"superUserName": user
				    },
				    crossDomain: true,
					cache : false,
				    error : function (XMLHttpRequest, textStatus, errorThrown){ 
				    	console.log("La requête POST(addAdmin) a échouée."); 
				    	alert("POST addAdmin : status = " + textStatus);
				    },
				    success: function(boo) {
				    	console.log("POST addAdmin est un succès.");
				    	console.log(boo);
				    	if(boo){
					    	$("#listAdmin").append("<option selected=\"selected\">" + user + "</option>");			    		
				    	}
				    }
				});
		    }
		}
		function deleteAdmin() {
			var user = $("#listAdmin option:selected").text();
			if(user == ""){
				return;
			}
		    if(confirm("Voulez-vous vraiment supprimer l'utilisateur "+ user + " du groupe Admin ?")){
		    	$.ajax({
				    type: "DELETE",
				    url: "http://127.0.0.1:8182/admin/superusers/" + user,
				    headers: {
				    	'Authorization': 'Basic ' + btoa('malapert:pwd')
				    },
				    crossDomain: true,
					cache : false,
				    error : function (XMLHttpRequest, textStatus, errorThrown){ 
				    	console.log("La requête DELETE(deleteAdmin) a échouée."); 
				    	alert("DELETE deleteAdmin : status = " + textStatus);
				    },
				    success: function(boo) {
				    	console.log("DELETE deleteAdmin est un succès.");
				    	console.log(boo);
				    	if(boo){
					    	$("#listAdmin option:selected").remove();				    		
				    	}
				    }
				});
		    } 
		}
		</script>
		
</html>